import 'dart:io';

import 'globals.dart';

String getConfigFileText(
        {String? link,
        String? earlier,
        String? later,
        String? regex,
        String? keep}) =>
    """
Config file generated by Record on Calendar
Only change values after colons! Leave a space after the colons!

iCal link for calendar
link: ${link ?? ""}

Start recording minutes earlier then calendar event start
earlier: ${earlier ?? "5"}

Stop recording minutes later then calendar event end
later: ${later ?? "30"}

Keep this number of latest recordings, delete older automatically (0 means never delete)
keep: ${keep ?? "0"}

Only record on events matching following regular expression (help: regexr.com)
"." means record every event
regex: ${regex ?? "."}

File generated by
version: $version
Don't change this line!
""";

String getConfigValue(String name, String configString) {
  List<String> lines = configString.split("\n");
  return lines
      .firstWhere((element) => element.startsWith(name))
      .substring(name.length + 2);
}

loadConfig() {
  String configString = configFile.readAsStringSync();

  try {
    var _startEarlierByMinutes =
        int.parse(getConfigValue('earlier', configString));
    var _endLaterByMinutes = int.parse(getConfigValue('later', configString));
    var _matchEventName = RegExp(getConfigValue('earlier', configString));
    iCalUri = Uri.parse(getConfigValue('link', configString));

    startEarlierByMinutes = _startEarlierByMinutes;
    endLaterByMinutes = _endLaterByMinutes;
    matchEventName = _matchEventName;
  } catch (e) {
    print(
        "Could not read config file! If this error persists, please delete file and let the program regenerate it by restarting.");
    print(e);
    print("Running with default values");
  }
}

import 'dart:io';

import 'package:path/path.dart';
import 'package:yaml/yaml.dart';

import '../globals.dart';
import 'log.dart';

String generateConfigText({
  bool? debug = false,
  String? google_calendar_id = "= PLEASE PUT A GOOGLE CALENDAR ID HERE =",
  String? google_api_key = "= PLEASE PUT A GOOGLE API KEY HERE =",
  int? frequency = 30,
  int? earlier = 5,
  int? later = 30,
  String? regex = ".",
  int keep = 0,
  bool dailyEmail = false,
  String dailyEmailRecipients = '[""]',
  bool calendarEmail = false,
  String calendarEmailRecipients = '[""]',
  String? smtpHost,
  int? smtpPort,
  String? smtpUser,
  String? smtpPassword,
  int? webPort = 8080,
  String dailyEmailSenderName = "Record On Calendar",
  String dailyEmailSubject = "Today's recorded events",
  String? dailyEmailContent,
  String calendarEmailSenderName = "Record On Calendar",
  String calendarEmailSubject = "Calendar updated",
  String? calendarEmailContent,
}) =>
    """
# █▀█ █▀▀ █▀▀ █▀█ █▄░█ █▀▀ ▄▀█ █░░
# █▀▄ ██▄ █▄▄ █▄█ █░▀█ █▄▄ █▀█ █▄▄

# Config file generated by Record on Calendar
version: $version # Don't change this!

# Config file format is YAML. The RecOnCal will try to migrate it to new versions if updated.
# Made by Benedek Fodor (RedyAu) in 2022-2024

debug: ${debug ?? false} # Set to true to see additional messages on console.

##########

# CALENDAR

# ID of Google Calendar
calendar_id: $google_calendar_id
# API key for Google Calendar
api_key: $google_api_key

# Update frequency of calendar (minutes)
frequency: $frequency
# Start recording minutes earlier then calendar event start
earlier: $earlier
# Stop recording minutes later then calendar event end
later: $later
# Only record on events matching following regular expression (help: regexr.com)
# "." means record every event
regex: $regex

##########

# FILES

# Keep this number of latest recordings, delete older automatically (0 means never delete)
keep: $keep

##########

# EMAIL

# Send email notification after last recording on a day
# true - enable; false - disable
dailyEmail: $dailyEmail
# Example for email recipients: [example@example.com, tim@apple.com]
dailyEmailRecipients: $dailyEmailRecipients
calendarEmail: $calendarEmail
calendarEmailRecipients: $calendarEmailRecipients

# Email client
smtpHost: $smtpHost
smtpPort: $smtpPort
smtpUser: $smtpUser
smtpPassword: $smtpPassword

# Host a web status page on this port (~ to disable)
webPort: ${webPort ?? '~'}

# Daily email content
dailyEmailSenderName: $dailyEmailSenderName
dailyEmailSubject: $dailyEmailSubject
# Available replacements: [today list] [future list] [stat - success count] [stat - failed count] [time]
# Make sure to put 2 spaces before every line.
dailyEmailContent: ${dailyEmailContent ?? """|
  RecordOnCalendar has just finished recording the last event for today.

  Recorded events today:
  [today list]

  Next 10 events to record in the future:
  [future list]

  Successfully recorded [stat - success count] events so far. Failed [stat - failed count] times.

  Email sent at [time]
"""}

# Calendar email content
calendarEmailSenderName: $calendarEmailSenderName
calendarEmailSubject: $calendarEmailSubject
calendarEmailContent: ${calendarEmailContent ?? """|
  RecordOnCalendar has detected that future events have been changed in the calendar.

  Next 10 events to record are:
  [future list]

  Email sent at [time]
"""}
""";

loadConfig() {
  logger.log('Loading config file');
  Map config;
  try {
    config = loadYaml(configFile.readAsStringSync());
  } catch (e, stack) {
    logger.log(
        "Could not parse config file! If this error persists, please delete file and let the program regenerate it by restarting.\n$e\n$stack");
    stdin.readLineSync();
    exit(1);
  }

  //! Migrate
  if (config['version'] != version) {
    configFile
        .copySync(withoutExtension(configFile.path) + ".${DateTime.now().toFormattedString()}.yaml.old");

    configFile.writeAsStringSync(
      generateConfigText(
        debug: config['debug'],
        google_calendar_id: config['calendar_id'],
        google_api_key: config['api_key'],
        frequency: config['frequency'],
        earlier: config['earlier'],
        later: config['later'],
        regex: config['regex'],
        keep: config['keep'],
        dailyEmail: config['dailyEmail'],
        dailyEmailRecipients: config['dailyEmailRecipients'].toString(),
        calendarEmail: config['calendarEmail'],
        calendarEmailRecipients: config['calendarEmailRecipients'].toString(),
        smtpHost: config['smtpHost'],
        smtpPort: config['smtpPort'],
        smtpUser: config['smtpUser'],
        smtpPassword: config['smtpPassword'],
        webPort: config['webPort'],
        dailyEmailSenderName: config['dailyEmailSenderName'],
        dailyEmailSubject: config['dailyEmailSubject'],
        dailyEmailContent: "|\n  " + (config['dailyEmailContent'] as String).replaceAll("\n", "\n  "),
        calendarEmailSenderName: config['calendarEmailSenderName'],
        calendarEmailSubject: config['calendarEmailSubject'],
        calendarEmailContent: "|\n  " + (config['calendarEmailContent'] as String).replaceAll("\n", "\n  "),
      ),
    );
    logger.log(
        '\nMigrated config file from version ${config['version']} to $version.\nPlease check it and re-run the program.');
    stdin.readLineSync();
    exit(0);
  }

  //! Load
  try {
    debug = config['debug'];
    googleCalendarId = config['calendar_id']!;
    googleApiKey = config['api_key']!;
    iCalUpdateFrequencyMinutes = config['frequency'];
    startEarlierByMinutes = config['earlier'];
    endLaterByMinutes = config['later'];
    eventSelectedForRecordMatcher = RegExp(config['regex']!);
    keepRecordings = config['keep'];
    dailyEmail = config['dailyEmail'] ?? false;
    dailyEmailRecipients = config['dailyEmailRecipients'].whereType<String>().toList();
    calendarEmail = config['calendarEmail'] ?? false;
    calendarEmailRecipients = config['calendarEmailRecipients'].whereType<String>().toList();
    smtpHost = config['smtpHost'];
    smtpPort = config['smtpPort'] ?? 0;
    smtpUser = config['smtpUser'] ?? "";
    smtpPassword = config['smtpPassword'] ?? "";
    webPort = config['webPort'];
    dailyEmailSenderName = config['dailyEmailSenderName'] ?? "";
    dailyEmailSubject = config['dailyEmailSubject'] ?? "";
    dailyEmailContent = config['dailyEmailContent'] ?? "";
    calendarEmailSenderName = config['calendarEmailSenderName'];
    calendarEmailSubject = config['calendarEmailSubject'];
    calendarEmailContent = config['calendarEmailContent'];
  } catch (e, s) {
    logger.log(
        "Could not get config values! If this error persists, please delete config.yaml and let the program regenerate it by restarting.\n\n$e\n$s");
    stdin.readLineSync();
    exit(1);
  }
}
